var RecService=function(){var optlyUtils={},Datasource=function(fetcherFnc,idx){this.run=function(){return fetcherFnc().then(function(recs){return recs.forEach(function(rec){rec.__optlyMeta__={rec_type:"datasource",rec_name:"custom_datasource_"+idx}}),{recs:recs,name:"custom_datasource_"+idx}})}},Recommender=function(serviceKeys,config){var recommenderName=config.name||config.id,getTarget=function(){switch(config.type){case"popular":return"popular";case"cobrowse":return config.target;case"user":return optlyUtils.visitor.visitorId}};this.run=function(){return optlyUtils.recommender.getRecommendationsFetcher(serviceKeys,getTarget(),{preFilter:config.prefilter,canonicalize:config.canonicalize,postFilter:config.postfilter}).next(config.max||10).then(function(recs){return recs.forEach(function(rec){rec.__optlyMeta__={rec_type:config.type,rec_name:recommenderName}}),{recs:recs,name:recommenderName}})}},Fetcher=function(fetcherConfig){var logger=fetcherConfig.log?console:{log:function(){},group:function(){},groupEnd:function(){},groupCollapsed:function(){},dir:function(){}};this.logger=logger,this.recommenders=[],this.datasources=[],this.addRecommender=function(config){return config.prefilter=config.prefilter||fetcherConfig.prefilter,config.postfilter=config.postfilter||fetcherConfig.postfilter,config.canonicalize=config.canonicalize||fetcherConfig.canonicalize,this.recommenders.push(new Recommender({recommenderServiceId:fetcherConfig.serviceId,recommenderId:config.id},config)),this},this.addDatasource=function(fetcherFnc){return this.datasources.push(new Datasource(fetcherFnc,this.datasources.length+1)),this},this.execAll=function(){var recommenderPromises=this.recommenders.map(function(r){return r.run()}),datasourcePromises=this.datasources.map(function(r){return r.run()}),allFetchPromises=recommenderPromises.concat(datasourcePromises);return Promise.all(allFetchPromises)},this.run=function(){var returnMap={};return this.execAll().then(function(recResultsObjs){logger.groupCollapsed("RECOMMENDATIONS"),recResultsObjs.forEach(function(recResultsInstance){returnMap[recResultsInstance.name]=recResultsInstance.recs});for(var r in returnMap)logger.groupCollapsed('Recommender "'+r+'" ('+returnMap[r].length+")"),logger.dir(returnMap[r]),logger.groupEnd();return logger.log("[Run] ",returnMap),logger.groupEnd(),returnMap})},this.merge=function(config){config=config||{};var results=[];return this.execAll().then(function(recResultsObjs){return logger.groupCollapsed("RECOMMENDATIONS"),recResultsObjs.forEach(function(recObj){logger.groupCollapsed('Recommender "'+recObj.name+'" ('+recObj.recs.length+") "),logger.dir(recObj.recs),logger.groupEnd(),results=results.concat(recObj.recs.map(function(rec){return rec}))}),config.max&&(results=results.slice(0,config.max)),logger.log("[Merged] ",results),logger.groupEnd(),results})}};return{init:function(config){return optlyUtils.recommender=optlyUtils.recommender||optimizely.get("recommender"),optlyUtils.visitor=optlyUtils.visitor||optimizely.get("visitor"),new Fetcher(config)}}}();