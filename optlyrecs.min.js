var RecService=function(){var e={},r=function(e,r){this.run=function(){return e().then(function(e){return e.forEach(function(e){e.__optlyMeta__={rec_type:"datasource",rec_name:"custom_datasource_"+r}}),{recs:e,name:"custom_datasource_"+r}})}},n=function(r,n){var t=n.name||n.id,o=function(){switch(n.type){case"popular":return"popular";case"cobrowse":return n.target;case"user":return e.visitor.visitorId}};this.run=function(){return e.recommender.getRecommendationsFetcher(r,o(),{preFilter:n.prefilter,canonicalize:n.canonicalize,postFilter:n.postfilter}).next(n.max||10).then(function(e){return e.forEach(function(e){e.__optlyMeta__={rec_type:n.type,rec_name:t}}),{recs:e,name:t}})}},t=function(e){var t=e.log?console:{log:function(){},group:function(){},groupEnd:function(){},groupCollapsed:function(){},dir:function(){}};this.logger=t,this.recommenders=[],this.datasources=[],this.addRecommender=function(r){return r.prefilter=r.prefilter||e.prefilter,r.postfilter=r.postfilter||e.postfilter,r.canonicalize=r.canonicalize||e.canonicalize,this.recommenders.push(new n({recommenderServiceId:e.serviceId,recommenderId:r.id},r)),this},this.addDatasource=function(e){return this.datasources.push(new r(e,this.datasources.length+1)),this},this.execAll=function(){var e=this.recommenders.map(function(e){return e.run()}),r=this.datasources.map(function(e){return e.run()}),n=e.concat(r);return Promise.all(n)},this.run=function(){var e={};return this.execAll().then(function(r){t.groupCollapsed("RECOMMENDATIONS"),r.forEach(function(r){e[r.name]=r.recs});for(var n in e)t.groupCollapsed('Recommender "'+n+'" ('+e[n].length+")"),t.dir(e[n]),t.groupEnd();return t.log("[Run] ",e),t.groupEnd(),e})},this.merge=function(e){e=e||{};var r=[];return this.execAll().then(function(n){return t.groupCollapsed("RECOMMENDATIONS"),n.forEach(function(e){t.groupCollapsed('Recommender "'+e.name+'" ('+e.recs.length+") "),t.dir(e.recs),t.groupEnd(),r=r.concat(e.recs.map(function(e){return e}))}),e.max&&(r=r.slice(0,e.max)),t.log("[Merged] ",r),t.groupEnd(),r})}};return{init:function(r){return e.recommender=e.recommender||optimizely.get("recommender"),e.visitor=e.visitor||optimizely.get("visitor"),new t(r)}}}();