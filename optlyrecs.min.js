var RecService=function(){var e={recommender:optimizely.get("recommender"),visitor:optimizely.get("visitor")},r=function(r,n){var t=n.name||n.id,o=function(){switch(n.type){case"popular":return"popular";case"cobrowse":return n.target;case"user":return e.visitor.visitorId}};this.run=function(){return e.recommender.getRecommendationsFetcher(r,o(),{preFilter:n.prefilter,canonicalize:n.canonicalize,postFilter:n.postfilter}).next(n.max||10).then(function(e){return e.forEach(function(e){e.__optlyMeta__={rec_type:n.type,rec_name:t}}),{recs:e,name:t}})}},n=function(e){var n=e.log?console:{log:function(){},group:function(){},groupEnd:function(){},groupCollapsed:function(){}};this.recommenders=[],this.addRecommender=function(n){return n.prefilter=n.prefilter||e.prefilter,n.postfilter=n.postfilter||e.postfilter,n.canonicalize=n.canonicalize||e.canonicalize,this.recommenders.push(new r({recommenderServiceId:e.serviceId,recommenderId:n.id},n)),this},this.execAll=function(){var e=this.recommenders.map(function(e){return e.run()});return Promise.all(e)},this.run=function(){var e={};return this.execAll().then(function(r){n.groupCollapsed("RECOMMENDATIONS"),r.forEach(function(r){e[r.name]=r.recs});for(var t in e)n.groupCollapsed('Recommender "'+t+'" ('+e[t].length+")"),n.dir(e[t]),n.groupEnd();return n.log("[Run] ",e),n.groupEnd(),e})},this.merge=function(e){e=e||{};var r=[];return this.execAll().then(function(t){return n.groupCollapsed("RECOMMENDATIONS"),t.forEach(function(e){n.groupCollapsed('Recommender "'+e.name+'" ('+e.recs.length+") "),n.dir(e.recs),n.groupEnd(),r=r.concat(e.recs.map(function(e){return e}))}),e.max&&(r=r.slice(0,e.max)),n.log("[Merged] ",r),n.groupEnd(),r})}};return{init:function(e){return new n(e)}}}();